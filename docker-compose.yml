services:
  # Backend Service - FastAPI
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: vantage-backend
    ports:
      - "8000:8000"
    environment:
      # Application Configuration
      - APP_NAME=VANTAGE Prior Art Analyst
      - APP_VERSION=1.0.0
      - DEBUG=True

      # Database
      - DATABASE_URL=sqlite:///./priorai.db

      # API Configuration
      - API_V1_PREFIX=/api/v1
      - CORS_ORIGINS=http://localhost:3000,http://frontend:3000

      # File Upload
      - MAX_FILE_SIZE=10485760
      - ALLOWED_EXTENSIONS=.pdf,.docx

      # watsonx Configuration
      - WATSONX_API_KEY=${WATSONX_API_KEY:-your_key}
      - WATSONX_PROJECT_ID=${WATSONX_PROJECT_ID:-your_project_id}
      - WATSONX_URL=${WATSONX_URL:-https://us-south.ml.cloud.ibm.com}

      # watsonx NLU
      - WATSONX_NLU_API_KEY=${WATSONX_NLU_API_KEY:-your_nlu_api_key}
      - WATSONX_NLU_URL=${WATSONX_NLU_URL:-https://api.us-south.natural-language-understanding.watson.cloud.ibm.com/instances/xxxxx}

      # watsonx Orchestrate
      - WATSONX_ORCHESTRATE_URL=${WATSONX_ORCHESTRATE_URL:-https://api.watsonx-orchestrate.ibm.com}
      - WATSONX_ORCHESTRATE_API_KEY=${WATSONX_ORCHESTRATE_API_KEY:-your_orchestrate_api_key}
      - WATSONX_ORCHESTRATE_TEAM_ID=${WATSONX_ORCHESTRATE_TEAM_ID:-your_team_id}
      - WATSONX_WORKFLOW_ID=${WATSONX_WORKFLOW_ID:-workflow-patent-analysis}

      # Watson Assistant
      - ASSISTANT_ID=${ASSISTANT_ID}

      # Orchestration Configuration
      - ORCHESTRATION_ID=${ORCHESTRATION_ID}
      - AGENT_ID=${AGENT_ID}
      - AGENT_BASE_URL=${AGENT_BASE_URL}

      # Enable watsonx Orchestrate multi-agent workflow
      - USE_WATSONX_ORCHESTRATE=${USE_WATSONX_ORCHESTRATE:-true}

      # Ground Truth Dataset
      - DATASET_PATH=${DATASET_PATH:-./training_data/ground_truth_dataset.json}

      # Google Patents API (optional)
      - GOOGLE_PATENTS_API_KEY=${GOOGLE_PATENTS_API_KEY:-your_google_api_key}

      # Clerk Authentication
      - NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=${NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY}
      - CLERK_SECRET_KEY=${CLERK_SECRET_KEY}

    volumes:
      # Persist database
      - ./backend/priorai.db:/app/priorai.db
      # Persist uploaded files and reports
      - ./backend/uploads:/app/uploads
      # Mount code for development (optional - remove in production)
      - ./backend/app:/app/app

    networks:
      - vantage-network

    restart: unless-stopped

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Frontend Service - Next.js
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        - NEXT_PUBLIC_API_URL=http://localhost:8000/api/v1
        - NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=${NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY}
        - CLERK_SECRET_KEY=${CLERK_SECRET_KEY}
    container_name: vantage-frontend
    ports:
      - "3000:3000"
    environment:
      # API URL (points to backend service)
      - NEXT_PUBLIC_API_URL=http://backend:8000/api/v1

      # Clerk Authentication
      - NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=${NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY}
      - CLERK_SECRET_KEY=${CLERK_SECRET_KEY}

      # Node Environment
      - NODE_ENV=production

    depends_on:
      backend:
        condition: service_healthy

    networks:
      - vantage-network

    restart: unless-stopped

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  vantage-network:
    driver: bridge

volumes:
  backend-db:
  backend-uploads:
